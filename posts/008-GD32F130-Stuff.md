# More LIDAR Stuff - Messing with the GD32F130F6P6
Since I had a "bricked" LDS-006 with no firmware on the data RX board, I decided to try and write some new firmware for it. This was to prove or disprove some of my assumptions on how the board works, and to eventually maybe write my own full firmware that could handle the incoming data from the spinny part, and then write it out over serial (in a nicer format). The IC used in the receiver board is the [GD32F130F6P6](https://www.gigadevice.com/microcontroller/gd32f130f6p6/), a knockoff of the STM32F103 but with a few extra features (namely an extra read-protection mode, see [here](https://www.usenix.org/system/files/woot20-paper-obermaier.pdf) for info).

Some DuckDuckGo'ing led me to [this repo](https://github.com/maxgerhardt/pio-gd32f130c6), which was for the GD32F130**C6**, however this and the F130F6P6 are very similar, the former just having more GPIO pins. I created a new board file for the F6P6 (see [~~here~~ **TODO**]() for project repo), and edited the stock `main.c` to just init and toggle one GPIO pin (PORTA GPIO14, since from the PCB it doesn't seem to be connected  to anything). I then successfully built a `firmware.bin` file with the PlatformIO VSCode extension, and I started up OpenOCD and tried flashing the file. Although it seemed to flash correctly, it didn't toggle the GPIO like I wanted (after a hard reset), and I then tried reconnecting over OpenOCD, but now it wouldn't connect to the target.

## Unbricking
So I was now worried that I had popped the chip, since I was probing around a lot, and could have easily shorted something out. More reading and examining the PCB led me to the `BOOT0` pin (pin 1 on the IC). I noted that it was pulled to ground via a resistor, which means that it will boot from internal flash. I then tried pulling the pin high, and as if by magic, OpenOCD now connected again :). I then did a mass erase, and thankfully the chip was then back in a working state.

**Note**: Pull the `BOOT0` pin to 3v3 if the chip isn't responding to OpenOCD; there are many connections going in and out of the chip, and potentially writing to random GPIO pins can soft brick the chip. When the pin is pulled high, do a mass erase in OpenOCD to get back to a known good state.

## Soldering to SWD
I would recommend soldering a 4-way wire to the SWD port, and adding connectors to the other end, since sticking 1mm pin headers into the holes isn't reliable, and can lead to accidentally shorting stuff. **TODO: Add image**

**More to come**

___

## Links
- https://github.com/maxgerhardt/pio-gd32f130c6 - PlatformIO setup for a similar chip
- https://www.usenix.org/system/files/woot20-paper-obermaier.pdf - paper on reading the flash of some chips
- https://www.gigadevice.com/microcontroller/gd32f130f6p6/ - info page on GD32F130F6P6